<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Polylines测试</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="animate.css">

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #map-div {
            height: 100%;
        }
        
        #map {
            height: 100%;
        }
        
        #control-panel-row {
            position: absolute;
            left: 0%;
            top: 0%;
            width: 100%;
            margin: 0;
            z-index: 5;
        }
        
        #control-panel-col {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #control-panel {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #searchPlace {
            width: auto;
        }
    </style>

</head>

<body>
    <div class="row" id="control-panel-row">
        <div class="col-md-12" id="control-panel-col">
            <div class="panel panel-default" id="control-panel">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-5 col-sm-8">
                            <div class="input-group">

                                <input type="text" class="form-control" placeholder="Search a place...">
                                <span class="input-group-btn">
        <button class="btn btn-default" type="button" id="load-region">Go!</button>
      </span>
                            </div>
                            <!-- /input-group -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--    <div class="row">
        <button class="btn-flat btn-warning" id="load-region">load all regions</button>
        <input type="text" id="region">
        <button class="btn-flat btn-success" id="submit">submit</button>
    </div>-->

    <div class="row" id="map-div">
        <div id="map"></div>
    </div>


    <!-- jQuery 2.1.4 -->
    <script src="jQuery-2.1.4.min.js"></script>
    <!-- Bootstrap 3.3.5 -->
    <script src="bootstrap.min.js"></script>
    <script src="d3.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAC01nTmNbpdoTQ5eu5v9vs1PpVb-Pbpq4&libraries=geometry">
    </script>
    <script src="v3_eshapes.js" type="text/javascript"></script>
    <script>
        var map;
        var TILE_SIZE = 256;
        var l_earth = 40075000;
        var r_earth = l_earth / (2 * Math.PI);
        var R = 10000;
        var hexArray = new Array();
        var hexPolyArray = new Array();
        var selectedShape;
        var minZoomLevel = 7;
        var maxValue = 0;
        var minValue = 0;

        //var hexSize = radius * TILE_SIZE / l_earth;
        var regions = [
            {
                "id": 001,
                "lat": 45.42929873257377,
                "long": -75.38818359375,
                "message": "人は誰もが挑戦者 迷い戸惑う闘(たたか)って",
                "create_date": "2015-10-01",
                "emotion": "positive",
                "value": 16
                }, {
                "id": 002,
                "lat": 45.39844997630408,
                "long": -74.86083984375,
                "message": "二つで一つが一つの虚しさ あるはずを失った暮らしが",
                "create_date": "2015-10-01",
                "emotion": "negative",
                "value": 90
                }, {
                "id": 003,
                "lat": 45.440862671781765,
                "long": -75.2508544921875,
                "message": "燃える夕焼け ふわり初雪",
                "create_date": "2015-10-01",
                "emotion": "neutral",
                "value": 85
                }, {
                "id": 004,
                "lat": 45.54483149242463,
                "long": -75.0531005859375,
                "message": "孤独や涙を 痛みや悲しみを",
                "create_date": "2015-10-01",
                "emotion": "neutral",
                "value": 47
                }, {
                "id": 005,
                "lat": 45.25555527789205,
                "long": -75.772705078125,
                "message": "他の空と繋ぐ “Hey！Hello！”",
                "create_date": "2015-10-01",
                "emotion": "positive",
                "value": 72
                }, {
                "id": 006,
                "lat": 45.30773430004869,
                "long": -75.6298828125,
                "message": "優しさを誇りに 気高くしなやかに",
                "create_date": "2015-10-01",
                "emotion": "positive",
                "value": 66
                }, {
                "id": 007,
                "lat": 45.37144349133922,
                "long": -75.552978515625,
                "message": "春待ち桜 月夜の花火",
                "create_date": "2015-10-01",
                "emotion": "neutral",
                "value": 23
                }, {
                "id": 008,
                "lat": 45.30000710263142,
                "long": -75.970458984375,
                "message": "君のいない部屋は　空き箱みたいに軽く",
                "create_date": "2015-10-01",
                "emotion": "negative",
                "value": 43
                }, {
                "id": 009,
                "lat": 45.37530235052552,
                "long": -75.61065673828125,
                "message": "どんなときも　離れてても 心に同じ空がある",
                "create_date": "2015-10-01",
                "emotion": "positive",
                "value": 82
                }
            ];

        $(function () {

            var ottawa = new google.maps.LatLng(45.42929873257377, -75.38818359375);

            map = new google.maps.Map(document.getElementById('map'), {
                center: ottawa,
                zoom: 9
            });

            //restrict zoom level to be at city level
            google.maps.event.addListener(map, 'zoom_changed', function () {
                    if (map.getZoom() < minZoomLevel) {
                        // get analysis data if zoom level < 9
                        map.setZoom(minZoomLevel);
                    } else {
                        // get original data if zoom level >=9
                        hexArray = [];
                        drawAllHex(map.getZoom());
                    }

                }

            );

        });


        function drawAllHex(zoom) {

            $.each(hexPolyArray, function () {
                this.setMap(null);
            });

            hexPolyArray = [];

            var radius = R * Math.pow(2, 9) / Math.pow(2, zoom);
            var hexSize = radius * TILE_SIZE / l_earth;
            var proj = map.getProjection();

            $.each(regions, function () {
                var id = this.id;
                var emotion = this.emotion;
                var latlong = new google.maps.LatLng(this.lat, this.long);
                var point_xy = proj.fromLatLngToPoint(latlong);
                var hex = getHexCoordinate(hexSize, point_xy);
                //var center_xy = getCenter(hexSize, hex);

                var flag = 0;

                $.each(hexArray, function () {
                    if ((this.q == hex.q) && (this.r == hex.r) && (this.s == hex.s)) {
                        flag = 1;
                        this.msg.push(id);
                        //alert("1:" + this.msg);
                        switch (emotion) {
                        case "positive":
                            this.positive++;
                            break;
                        case "neutral":
                            this.neutral++;
                            break;
                        case "negative":
                            this.negative++;
                            break;
                        default:
                            break;
                        }
                    }

                });

                if (flag == 0) {
                    hex.msg.push(id);
                    //alert("0:" + hex.msg);
                    switch (emotion) {
                    case "positive":
                        hex.positive++;
                        break;
                    case "neutral":
                        hex.neutral++;
                        break;
                    case "negative":
                        hex.negative++;
                        break;
                    default:
                        break;
                    }
                    hexArray.push(hex);
                }


            });

            $.each(hexArray, function () {
                //alert(this.positive + "," + this.neutral + "," + this.negative);
                alert(this.q+","+this.r+","+this.s+"  PNN:"+this.positive+","+this.neutral+","+this.negative);
                drawHexFromHex(this, zoom);
            });


        }


        function Hex(q, r, s, positive, neutral, negative, msg) {
            this.q = q;
            this.r = r;
            this.s = s;
            this.positive = positive;
            this.neutral = neutral;
            this.negative = negative;
            this.msg = msg;
        }



        //world coordinate to hex coordinate
        function getHexCoordinate(hexSize, worldCoordinate) {
            var x = worldCoordinate.x;
            var y = worldCoordinate.y;
            q = (x * Math.sqrt(3) / 3 - y / 3) / hexSize;
            r = y * 2 / 3 / hexSize;
            var cx = q;
            var cz = r;
            var cy = -cx - cz;

            var rx = Math.round(cx);
            var ry = Math.round(cy);
            var rz = Math.round(cz);

            var x_diff = Math.abs(rx - cx);
            var y_diff = Math.abs(ry - cy);
            var z_diff = Math.abs(rz - cz);

            if ((x_diff > y_diff) && (x_diff > z_diff)) {
                rx = -ry - rz;
            } else if (y_diff > z_diff) {
                ry = -rx - rz;
            } else {
                rz = -rx - ry;
            }

            var hex = new Hex(rx, ry, rz, 0, 0, 0, new Array());
            return hex;
        }


        //get hex center's world coordinate from hex coordinate
        function getCenter(hexSize, hex) {
            var x = hexSize * Math.sqrt(3) * (hex.q + hex.s / 2);
            var y = hexSize * 3 / 2 * hex.s;
            return new google.maps.Point(x, y);

        }



        function drawHexFromHex(hex, zoom) {
            var proj = map.getProjection();
            var radius = R * Math.pow(2, 9) / Math.pow(2, zoom);
            var hexSize = radius * TILE_SIZE / l_earth;
            var center = getCenter(hexSize, hex);
            //alert(center);
            var p1, p2, p3, p4, p5, p6;
            p1 = new google.maps.Point((center.x - Math.sqrt(3) * hexSize / 2), (center.y + 0.5 * hexSize));
            p2 = new google.maps.Point(center.x, (center.y + hexSize));
            p3 = new google.maps.Point((center.x + Math.sqrt(3) * hexSize / 2), (center.y + 0.5 * hexSize));
            p4 = new google.maps.Point((center.x + Math.sqrt(3) * hexSize / 2), (center.y - 0.5 * hexSize));
            p5 = new google.maps.Point(center.x, (center.y - hexSize));
            p6 = new google.maps.Point((center.x - Math.sqrt(3) * hexSize / 2), (center.y - 0.5 * hexSize));
            var hexPolygon = new google.maps.Polygon({
                paths: [proj.fromPointToLatLng(p1), proj.fromPointToLatLng(p2), proj.fromPointToLatLng(p3), proj.fromPointToLatLng(p4), proj.fromPointToLatLng(p5), proj.fromPointToLatLng(p6), proj.fromPointToLatLng(p1)],
                strokeWeight: 0,
                fillColor: getColorFromHex(hex),
                fillOpacity: 0.5
            });
            hexPolygon.setMap(map);
            hexPolyArray.push(hexPolygon);

        }
        
        
        
        


        function getColorFromHex(hex) {
            var palegreen = d3.rgb(0, 255, 255); //浅蓝
            var darkgreen = d3.rgb(0, 0, 255); //深蓝
            var color = d3.interpolate(palegreen, darkgreen); //颜色插值函数
            var linear = d3.scale.linear().domain([-3, 3]).range([0, 1]);
            var value = hex.positive - hex.negative;
            return color(linear(value));
        }



        $("#load-region").click(function () {
            $.each(hexPolyArray, function () {
                this.setMap(null);
            });

            hexPolyArray = [];
            hexArray = [];
            drawAllHex(map.getZoom());
        });
    </script>
</body>

</html>